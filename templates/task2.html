{% extends 'header.html' %}
{% block task2 %}
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
       .game-container{
        max-width: 600px;
        margin: 50px auto;
        text-align:center;
       }
      .game-area{
        height: 400px;
        width: 100%;
        border: 2px solid black;
        border-radius: 10px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 25px;
        font-weight: bold;
        margin-bottom: 20px;
      }
      #start-btn{
        width: 150px;
        margin-top: 20px;
      }
      #feedback{
        margin-top: 10px;
        font-size: 20px;
          color: #28a745;
      }
       #response-time{
        font-weight:bold;
           color: #dc3545;
       }
    </style>
</head>
<body>
  <div class="container game-container">
    <h1 class="text-center mb-4">Stop and Go Game</h1>
    <div class="game-area" id ="game-area">
        Press the Button!
    </div>
    <button class="btn btn-primary" id="start-btn">Start</button>
    <p id="feedback" class="text-center"></p>
    <p class="text-center">Response Time: <span id="response-time">0</span> ms</p>
    <div id="results" class="text-center"></div>
  </div>
  <script>

      let trials = []; // list that contains the problems --> ex) ["Go", "NGO", "GO",,...]
      let currentTrial = 0;
      let responseTime = 0;
      let startTime;
      let timeoutId;

      let correctResponses = []; // for tracking the number of correct trials
      let incorrectResponses = []; // for tracking the number of incorrect trials
      let responseTimes =[]; // for tracking the responsTimes for correct tirals

      const trialDelay = 1000; // 1-second delay between trials

      document.getElementById('start-btn').addEventListener('click', startGame);
      document.addEventListener('keydown', handleKeydown);

      function startGame(){
          // Reset Game State
          currentTrial = 0;
          responseTime = 0;
          document.getElementById('feedback').textContent = '';
          document.getElementById('response-time').textContent = 0;
          trials = generateTrials(); // ["Go", "NGO", "GO",,...]
          showNextTrial();
      }
      // Generating the random Trials
      function generateTrials(){
          generatedTrials = [];
          for (let i = 0; i<5; i++){
              //Math.random() --> 0~1
              // if we generate the random number between 0 to 1, and if the number is less than 0.8
              // Then, we push 1 (Go), otherwise push 0 (NO-GO)
              generatedTrials.push(Math.random() < 0.8 ? 1 : 0) // 80% : Go 20% No
          }
          return generatedTrials;
      }
      function showNextTrial(){
          if (currentTrial < trials.length){
               flashScreen();
              setTimeout(()=>{
                      trialType = trials[currentTrial];
                      //Display Go if the trialType is 1 , No-Go otherwise.
                      document.getElementById('game-area').textContent = trialType === 1 ? "GO" : "NO GO";
                      startTime = Date.now(); //Date.now() will get the current date and time

                      clearTimeout(timeoutId);
                      timeoutId = setTimeout(() => {
                            if (trialType === 1){
                                document.getElementById('feedback').textContent = 'Time out!';
                                incorrectResponses.push(trialType);
                                responseTimes.push(null);
                            }
                            currentTrial++;
                            showNextTrial();
                      }, 2000); // 2000 ms --> 2s
                }, trialDelay);
          }else{
            document.getElementById('game-area').textContent = "Task Complete!";
            clearTimeout(timeoutId);
              displayResults();
          }
      }
      function handleKeydown(event){
         if(event.code === 'Space' && currentTrial < trials.length){ // check if spacebar is pressed
             trialType = trials[currentTrial];
             const endTime = Date.now();
             responseTime = endTime - startTime;

             document.getElementById('response-time').textContent = responseTime;

             clearTimeout(timeoutId);


             // TrialType
             // TrialType is 1 --> GO
             // TrialType is 0 --> No go

             if (trialType === 1){
                document.getElementById('feedback').textContent = "Correct!";
                 correctResponses.push(trialType);
                 responseTimes.push(responseTime);
             }else{
                document.getElementById('feedback').textContent = "Wrong!";
                 incorrectResponses.push(trialType);
                 responseTimes.push(null);
             }

             // Add delay before moving to the next trial
             setTimeout(() => {
                 currentTrial++;
                showNextTrial();
             }, 500); // 0.5s delay before moving to the next trial

         }
      }
      function flashScreen(){
        const gameArea = document.getElementById('game-area');
          gameArea.textContent = "";
          gameArea.style.backgroundColor = "#fbfedd";
          setTimeout(() =>{
            gameArea.style.backgroundColor = "white";
          }, 300);

      }
      function average_with_skip(lst){
            validTimes = lst.filter(time => time !== null && time !== undefined && typeof time === 'number');
            if (validTimes.length === 0 ){
                return 0;
            }
            sum = validTimes.reduce((a,b) => a+b, 0);
            return sum / validTimes.length;
      }
      // Function for displaying the result for the task.
      function displayResults(){
          let resultHTML = '<h3>Results:</h3>'
          resultHTML += `<p>Correct Responses: ${correctResponses.length}</p>`
          resultHTML += `<p>Incorrect Responses: ${incorrectResponses.length}</p>`
          resultHTML += `<p>Average Response Times: ${responseTimes.join(', ')} ms</p>`;
          document.getElementById('results').innerHTML = resultHTML;

          average_response = average_with_skip(responseTimes);

          game_data = {
            correct_answers: correctResponses.length,
            wrong_answers:   incorrectResponses.length,
              response_times: responseTimes, // [147,133,151, , , ,]
              average_response: average_response,
              timestamp: new Date().toISOString()
          };
          fetch('/add_task2',{
            method: "POST",
              headers: {
                'Content-Type': 'application/json'
              },
            body: JSON.stringify(game_data)
          }).then(response => response.json())
          .then(data => {
            if(data.status === "success"){
                console.log("Success");
            }else{
                console.log("Error");
            }
          }).catch(error => {
            console.log("Error", error);
          });
      }


  </script>
</body>
{% endblock %}
</html>