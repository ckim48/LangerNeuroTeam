{% extends 'header.html' %}
{% block task2 %}
    <style>
        /* General page styling */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9f9f9;
            color: #333;
        }

        .game-container {
            max-width: 600px;
            margin: 50px auto;
            text-align: center;
        }

        .card {
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .game-area {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            background-color: #f1f1f1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        #start-btn {
            width: 150px;
            margin: 0 auto;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        #start-btn:hover {
            background-color: #0056b3;
        }

        #trial-number {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #007bff;
        }

        .traffic-light {
            position: absolute;
            display: block;
            height: 150px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }

        .traffic-light.active {
            opacity: 1;
            visibility: visible;
        }

        #break-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
            color: #fff;
            font-size: 2rem;
            pointer-events: none;
        }

        #break-message p {
            background-color: #28a745;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .game-area {
                height: 300px;
            }
        }
    </style>

    <body>
        <div class="container game-container">
            <div class="modal fade"  id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Instructions for Task 2: Stoplight Reaction Time Exercise</h5>

                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                               <p>Task 2 will test your reaction time with a stoplight visual that indicates a “go” and a “no-go.” As yo
u go further in this task, the number of “go’s” will increase, while the number of “no-go’s” will decrease.</p>
                            <ul>
<li>1. When the stoplight flashes green, click with your mouse. Speed is important, as this measures your reaction time.</li>
<li>When the stoplight flashes yellow, you must not click.</li>
<li>If you are successful, the game will continue, and
the number of “go’s” and “no-go’s” will change as you progress.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h1 class="text-center mb-4">Stop and Go Game</h1>
                 <button type="button" class="icon-btn"  data-bs-toggle="modal" data-bs-target="#infoModal">
                    <i class="bi bi-info-circle"></i>
                </button>
                <div id="trial-number" class="text-center"></div>
                <div class="game-area" id="game-area">
                    <img id="green-light" src="../static/images/assets/green.png" class="traffic-light" alt="Green Light">
                    <img id="red-light" src="../static/images/assets/red.png" class="traffic-light" alt="Red Light">
                    <img id="orange-light" src="../static/images/assets/yellow.png" class="traffic-light" alt="Orange Light">
                </div>
                <button type="button" id="start-btn">Start</button>
            </div>

            <div id="break-message" style="display:none;">
                <p>Next level starting in <span id="break-timer">5</span> seconds...</p>
            </div>
        </div>

        <script>
            let blockLevels = [
                { goTrials: 30, noGoTrials: 10 }, // Level 1
                { goTrials: 25, noGoTrials: 15 }, // Level 2
                { goTrials: 35, noGoTrials: 5 }   // Level 3
            ];

            let currentLevel = 0;
            let currentTrial = 0;
            let trials = [];
            let timeoutId;
            let gameStarted = false;
            let isBreakActive = false;
            let isTrialActive = false;

            let score = 0;
            let goTrialResponseTimes = [];

            document.getElementById('start-btn').addEventListener('click', startGame);
            document.addEventListener('keydown', handleKeydown);

            function startGame() {
                gameStarted = true;
                currentTrial = 0;
                currentLevel = 0;
                score = 0;
                goTrialResponseTimes = [];
                trials = generateBalancedTrials(blockLevels[currentLevel]);
                startNextLevel();
            }

            function startNextLevel() {
                currentTrial = 0;
                document.getElementById('break-message').style.display = 'none';
                showNextTrial();
            }

            function generateBalancedTrials(block) {
                let goTrials = new Array(block.goTrials).fill(1);  // Go trials
                let noGoTrials = new Array(block.noGoTrials).fill(0);  // No-go trials
                let combinedTrials = goTrials.concat(noGoTrials);

                // Shuffle the trials
                for (let i = combinedTrials.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [combinedTrials[i], combinedTrials[j]] = [combinedTrials[j], combinedTrials[i]];
                }

                return combinedTrials;
            }

            function showNextTrial() {
                if (currentTrial < trials.length) {
                    updateTrialNumber(currentTrial + 1, trials.length);
                    isTrialActive = true;

                    hideAllLights();
                    showLight('orange-light');

                    setTimeout(() => {
                        let trialType = trials[currentTrial];
                        if (trialType === 1) {
                            switchLight('orange-light', 'green-light'); // Go trial
                            startResponseTimer();  // Start timing for Go trial
                        } else {
                            switchLight('orange-light', 'red-light'); // No-go trial
                        }

                        timeoutId = setTimeout(() => {
                            isTrialActive = false;
                            currentTrial++;
                            showNextTrial();
                        }, 2000);
                    }, 500);
                } else {
                    currentLevel++;
                    if (currentLevel < blockLevels.length) {
                        showBreakScreen(() => {
                            trials = generateBalancedTrials(blockLevels[currentLevel]);
                            startNextLevel();
                        });
                    } else {
                        document.getElementById('game-area').textContent = "Task Complete!";
                        clearTimeout(timeoutId);

                        // Calculate and send the score and average response time
                        const totalScore = score;
                        const avgResponseTime = calculateAverage(goTrialResponseTimes);
                        sendTask2Result({ totalScore, avgResponseTime });
                    }
                }
            }

            let responseStartTime;
            function startResponseTimer() {
                responseStartTime = Date.now();
            }

            function handleKeydown(event) {
                if (event.code === 'Space') {
                    event.preventDefault();
                }

                if (!isBreakActive && event.code === 'Space' && isTrialActive && gameStarted) {
                    clearTimeout(timeoutId);

                    const trialType = trials[currentTrial];
                    if (trialType === 1) {
                        // Go trial, track response time
                        const responseTime = (Date.now() - responseStartTime) / 1000;
                        goTrialResponseTimes.push(Math.min(responseTime, 2));  // Cap at 2 seconds
                        score++;  // Correct response adds to score
                    } else {
                        // No-go trial, wrong response
                        alert("Oops! You shouldn't press space on the red light!");
                    }
                    isTrialActive = false;
                    currentTrial++;
                    showNextTrial();
                }
            }

            function switchLight(fromLightId, toLightId) {
                document.getElementById(fromLightId).classList.remove('active');
                document.getElementById(toLightId).classList.add('active');
            }

            function showLight(lightId) {
                document.getElementById(lightId).classList.add('active');
            }

            function hideAllLights() {
                document.getElementById('green-light').classList.remove('active');
                document.getElementById('red-light').classList.remove('active');
                document.getElementById('orange-light').classList.remove('active');
            }

            function updateTrialNumber(current, total) {
                document.getElementById('trial-number').innerText = `Trial ${current} of ${total}`;
            }

            function showBreakScreen(callback) {
                isBreakActive = true;
                const breakMessage = document.getElementById('break-message');
                breakMessage.style.display = 'flex';
                let timeRemaining = 5;
                const breakTimerElement = document.getElementById('break-timer');
                breakTimerElement.textContent = timeRemaining;

                const breakTimer = setInterval(() => {
                    timeRemaining--;
                    breakTimerElement.textContent = timeRemaining;

                    if (timeRemaining === 0) {
                        clearInterval(breakTimer);
                        breakMessage.style.display = 'none';
                        isBreakActive = false;
                        callback();
                    }
                }, 1000);
            }

            function calculateAverage(times) {
                const total = times.reduce((acc, time) => acc + time, 0);
                return total / times.length;
            }

            function sendTask2Result(resultData) {
                fetch('/add_task2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(resultData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        console.log('Task 2 result saved successfully');
                    } else {
                        console.error('Failed to save task 2 result:', data.error);
                    }
                })
                .catch((error) => {
                    console.error('Error saving task 2 result:', error);
                });
            }
        </script>
    </body>
{% endblock %}
